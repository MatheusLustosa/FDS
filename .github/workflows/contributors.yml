name: Update Contributors List

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Generate Contributors List
        uses: actions/github-script@v6
        with:
          script: |
            const contributors = await github.paginate(
              github.rest.repos.listContributors,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              }
            );

            const contributorList = `
            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
              ${contributors.map(
                contributor => `
                  <div style="text-align: center; width: 100px;">
                    <a href="${contributor.html_url}" style="display: block;">
                      <img src="${contributor.avatar_url}&s=64" width="64" height="64" alt="${contributor.login}" style="border-radius: 50%;"/>
                    </a>
                    <p><a href="${contributor.html_url}" style="text-decoration: none; color: #0366d6;">@${contributor.login}</a></p>
                  </div>`
              ).join('')}
            </div>`;

            const { data: readmeContent } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'README.md'
            });

            const readmeBuffer = Buffer.from(readmeContent.content, 'base64');
            let readmeText = readmeBuffer.toString('utf-8');

            const startMarker = '<!-- markdown-contributors -->';
            const endMarker = '<!-- /markdown-contributors -->';

            const startIndex = readmeText.indexOf(startMarker) + startMarker.length;
            const endIndex = readmeText.indexOf(endMarker);

            // Escape any HTML characters that might interfere with Markdown rendering
            const escapedContributorList = contributorList.replace(/</g, '&lt;').replace(/>/g, '&gt;');

            const newReadmeText = `${readmeText.substring(0, startIndex)}\n${escapedContributorList}\n${readmeText.substring(endIndex)}`;

            const newReadmeBuffer = Buffer.from(newReadmeText, 'utf-8');

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'README.md',
              message: 'Update contributors list',
              content: newReadmeBuffer.toString('base64'),
              sha: readmeContent.sha
            });
